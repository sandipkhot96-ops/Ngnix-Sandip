pipeline {
  agent any

  parameters {
    string(
      name: 'IMAGE_TAG',
      defaultValue: '',
      description: 'Enter Docker image tag to deploy (generated from build job)'
    )
  }

  environment {
    HELM_RELEASE = "new-nginx"
    HELM_CHART   = "./deploy/my-nginx"
    DOCKER_REPO  = "sandipkhot96"
    NAMESPACE    = "jenkins"
  }

  stages {

    stage('Clone Repository') {
      steps {
        git branch: 'main',
            url: 'https://github.com/sandipkhot96-ops/Ngnix-Sandip.git'
      }
    }

    stage('Deploy using Helm') {
      steps {
        script {
          // Use IMAGE_TAG passed from build job or parameter
          def tag = params.IMAGE_TAG
          if (tag == '') {
            error("Please provide IMAGE_TAG parameter from build job")
          }

          sh """
            echo "Deploying custom image: ${DOCKER_REPO}/custom-nginx:${tag}"

            # Ensure Minikube Docker environment is active
            eval \$(minikube docker-env)

            # Ensure KUBECONFIG points to Minikube
            export KUBECONFIG=$HOME/.kube/config

            # Create namespace if it doesn't exist
            kubectl get ns ${NAMESPACE} || kubectl create ns ${NAMESPACE}

            # Deploy with Helm using the dynamic image tag
            helm upgrade --install ${HELM_RELEASE} ${HELM_CHART} \
              --set image.repository=${DOCKER_REPO}/custom-nginx \
              --set image.tag=${tag} \
              -n ${NAMESPACE} --wait
          """
        }
      }
    }

    stage('Verify Deployment') {
      steps {
        sh """
          kubectl get pods -n ${NAMESPACE}
          kubectl get svc -n ${NAMESPACE}
        """
      }
    }
  }

  post {
    success {
      echo "✅ Helm deployment completed successfully!"
    }
    failure {
      echo "❌ Helm deployment failed!"
    }
  }
}
